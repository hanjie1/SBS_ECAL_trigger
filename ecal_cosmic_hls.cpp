#include "ecal_cosmic_hls.h"
using namespace std;

/* detector channels maps
 * row, col, super module 
 * row -- row number
 * col -- colum number for that row
 * super module -- which super module for that crate it belongs to
 * Crate 1 -7 have different maps
 * Here is the map for crate 1
*/ 
#ifdef CRATE1
block_coords detmap[NDETCHAN] = { {1,1,1},{1,2,1},{1,3,1},{1,4,2},{1,5,2},{1,6,2},{1,7,3},{1,8,3},{1,9,3},{1,10,4},{1,11,4},{1,12,4},{2,1,1},{2,2,1},{2,3,1},{2,4,2},{2,5,2},{2,6,2},{2,7,3},{2,8,3},{2,9,3},{2,10,4},{2,11,4},{2,12,4},{3,1,1},{3,2,1},{3,3,1},{3,4,2},{3,5,2},{3,6,2},{3,7,3},{3,8,3},{3,9,3},{3,10,4},{3,11,4},{3,12,4},{4,1,5},{4,2,5},{4,3,5},{4,4,6},{4,5,6},{4,6,6},{4,7,7},{4,8,7},{4,9,7},{4,10,8},{4,11,8},{4,12,8},{4,13,9},{4,14,9},{4,15,9},{4,16,10},{4,17,10},{4,18,10},{5,1,5},{5,2,5},{5,3,5},{5,4,6},{5,5,6},{5,6,6},{5,7,7},{5,8,7},{5,9,7},{5,10,8},{5,11,8},{5,12,8},{5,13,9},{5,14,9},{5,15,9},{5,16,10},{5,17,10},{5,18,10},{6,1,5},{6,2,5},{6,3,5},{6,4,6},{6,5,6},{6,6,6},{6,7,7},{6,8,7},{6,9,7},{6,10,8},{6,11,8},{6,12,8},{6,13,9},{6,14,9},{6,15,9},{6,16,10},{6,17,10},{6,18,10},{7,1,11},{7,2,11},{7,3,11},{7,4,12},{7,5,12},{7,6,12},{7,7,13},{7,8,13},{7,9,13},{7,10,14},{7,11,14},{7,12,14},{7,13,15},{7,14,15},{7,15,15},{7,16,16},{7,17,16},{7,18,16},{7,19,17},{7,20,17},{7,21,17},{8,1,11},{8,2,11},{8,3,11},{8,4,12},{8,5,12},{8,6,12},{8,7,13},{8,8,13},{8,9,13},{8,10,14},{8,11,14},{8,12,14},{8,13,15},{8,14,15},{8,15,15},{8,16,16},{8,17,16},{8,18,16},{8,19,17},{8,20,17},{8,21,17},{9,1,11},{9,2,11},{9,3,11},{9,4,12},{9,5,12},{9,6,12},{9,7,13},{9,8,13},{9,9,13},{9,10,14},{9,11,14},{9,12,14},{9,13,15},{9,14,15},{9,15,15},{9,16,16},{9,17,16},{9,18,16},{9,19,17},{9,20,17},{9,21,17},{10,1,18},{10,2,18},{10,3,18},{10,4,19},{10,5,19},{10,6,19},{10,7,20},{10,8,20},{10,9,20},{10,10,21},{10,11,21},{10,12,21},{10,13,22},{10,14,22},{10,15,22},{10,16,23},{10,17,23},{10,18,23},{10,19,24},{10,20,24},{10,21,24},{11,1,18},{11,2,18},{11,3,18},{11,4,19},{11,5,19},{11,6,19},{11,7,20},{11,8,20},{11,9,20},{11,10,21},{11,11,21},{11,12,21},{11,13,22},{11,14,22},{11,15,22},{11,16,23},{11,17,23},{11,18,23},{11,19,24},{11,20,24},{11,21,24},{12,1,18},{12,2,18},{12,3,18},{12,4,19},{12,5,19},{12,6,19},{12,7,20},{12,8,20},{12,9,20},{12,10,21},{12,11,21},{12,12,21},{12,13,22},{12,14,22},{12,15,22},{12,16,23},{12,17,23},{12,18,23},{12,19,24},{12,20,24},{12,21,24}};
#endif

#ifdef CRATE2
block_coords detmap[NDETCHAN] = { {1,1,1},{1,2,1},{1,3,1},{1,4,2},{1,5,2},{1,6,2},{1,7,3},{1,8,3},{1,9,3},{1,10,4},{1,11,4},{1,12,4},{1,13,5},{1,14,5},{1,15,5},{1,16,6},{1,17,6},{1,18,6},{1,19,7},{1,20,7},{1,21,7},{1,22,8},{1,23,8},{1,24,8},{2,1,1},{2,2,1},{2,3,1},{2,4,2},{2,5,2},{2,6,2},{2,7,3},{2,8,3},{2,9,3},{2,10,4},{2,11,4},{2,12,4},{2,13,5},{2,14,5},{2,15,5},{2,16,6},{2,17,6},{2,18,6},{2,19,7},{2,20,7},{2,21,7},{2,22,8},{2,23,8},{2,24,8},{3,1,1},{3,2,1},{3,3,1},{3,4,2},{3,5,2},{3,6,2},{3,7,3},{3,8,3},{3,9,3},{3,10,4},{3,11,4},{3,12,4},{3,13,5},{3,14,5},{3,15,5},{3,16,6},{3,17,6},{3,18,6},{3,19,7},{3,20,7},{3,21,7},{3,22,8},{3,23,8},{3,24,8},{4,1,9},{4,2,9},{4,3,9},{4,4,10},{4,5,10},{4,6,10},{4,7,11},{4,8,11},{4,9,11},{4,10,12},{4,11,12},{4,12,12},{4,13,13},{4,14,13},{4,15,13},{4,16,14},{4,17,14},{4,18,14},{4,19,15},{4,20,15},{4,21,15},{4,22,16},{4,23,16},{4,24,16},{5,1,9},{5,2,9},{5,3,9},{5,4,10},{5,5,10},{5,6,10},{5,7,11},{5,8,11},{5,9,11},{5,10,12},{5,11,12},{5,12,12},{5,13,13},{5,14,13},{5,15,13},{5,16,14},{5,17,14},{5,18,14},{5,19,15},{5,20,15},{5,21,15},{5,22,16},{5,23,16},{5,24,16},{6,1,9},{6,2,9},{6,3,9},{6,4,10},{6,5,10},{6,6,10},{6,7,11},{6,8,11},{6,9,11},{6,10,12},{6,11,12},{6,12,12},{6,13,13},{6,14,13},{6,15,13},{6,16,14},{6,17,14},{6,18,14},{6,19,15},{6,20,15},{6,21,15},{6,22,16},{6,23,16},{6,24,16},{7,1,17},{7,2,17},{7,3,17},{7,4,18},{7,5,18},{7,6,18},{7,7,19},{7,8,19},{7,9,19},{7,10,20},{7,11,20},{7,12,20},{7,13,21},{7,14,21},{7,15,21},{7,16,22},{7,17,22},{7,18,22},{7,19,23},{7,20,23},{7,21,23},{7,22,24},{7,23,24},{7,24,24},{7,25,25},{7,26,25},{7,27,25},{8,1,17},{8,2,17},{8,3,17},{8,4,18},{8,5,18},{8,6,18},{8,7,19},{8,8,19},{8,9,19},{8,10,20},{8,11,20},{8,12,20},{8,13,21},{8,14,21},{8,15,21},{8,16,22},{8,17,22},{8,18,22},{8,19,23},{8,20,23},{8,21,23},{8,22,24},{8,23,24},{8,24,24},{8,25,25},{8,26,25},{8,27,25},{9,1,17},{9,2,17},{9,3,17},{9,4,18},{9,5,18},{9,6,18},{9,7,19},{9,8,19},{9,9,19},{9,10,20},{9,11,20},{9,12,20},{9,13,21},{9,14,21},{9,15,21},{9,16,22},{9,17,22},{9,18,22},{9,19,23},{9,20,23},{9,21,23},{9,22,24},{9,23,24},{9,24,24},{9,25,25},{9,26,25},{9,27,25}};
#endif

#ifdef CRATE3_4_5
block_coords detmap[NDETCHAN] = { {1,1,1},{1,2,1},{1,3,1},{1,4,2},{1,5,2},{1,6,2},{1,7,3},{1,8,3},{1,9,3},{1,10,4},{1,11,4},{1,12,4},{1,13,5},{1,14,5},{1,15,5},{1,16,6},{1,17,6},{1,18,6},{1,19,7},{1,20,7},{1,21,7},{1,22,8},{1,23,8},{1,24,8},{1,25,9},{1,26,9},{1,27,9},{2,1,1},{2,2,1},{2,3,1},{2,4,2},{2,5,2},{2,6,2},{2,7,3},{2,8,3},{2,9,3},{2,10,4},{2,11,4},{2,12,4},{2,13,5},{2,14,5},{2,15,5},{2,16,6},{2,17,6},{2,18,6},{2,19,7},{2,20,7},{2,21,7},{2,22,8},{2,23,8},{2,24,8},{2,25,9},{2,26,9},{2,27,9},{3,1,1},{3,2,1},{3,3,1},{3,4,2},{3,5,2},{3,6,2},{3,7,3},{3,8,3},{3,9,3},{3,10,4},{3,11,4},{3,12,4},{3,13,5},{3,14,5},{3,15,5},{3,16,6},{3,17,6},{3,18,6},{3,19,7},{3,20,7},{3,21,7},{3,22,8},{3,23,8},{3,24,8},{3,25,9},{3,26,9},{3,27,9},{4,1,10},{4,2,10},{4,3,10},{4,4,11},{4,5,11},{4,6,11},{4,7,12},{4,8,12},{4,9,12},{4,10,13},{4,11,13},{4,12,13},{4,13,14},{4,14,14},{4,15,14},{4,16,15},{4,17,15},{4,18,15},{4,19,16},{4,20,16},{4,21,16},{4,22,17},{4,23,17},{4,24,17},{4,25,18},{4,26,18},{4,27,18},{5,1,10},{5,2,10},{5,3,10},{5,4,11},{5,5,11},{5,6,11},{5,7,12},{5,8,12},{5,9,12},{5,10,13},{5,11,13},{5,12,13},{5,13,14},{5,14,14},{5,15,14},{5,16,15},{5,17,15},{5,18,15},{5,19,16},{5,20,16},{5,21,16},{5,22,17},{5,23,17},{5,24,17},{5,25,18},{5,26,18},{5,27,18},{6,1,10},{6,2,10},{6,3,10},{6,4,11},{6,5,11},{6,6,11},{6,7,12},{6,8,12},{6,9,12},{6,10,13},{6,11,13},{6,12,13},{6,13,14},{6,14,14},{6,15,14},{6,16,15},{6,17,15},{6,18,15},{6,19,16},{6,20,16},{6,21,16},{6,22,17},{6,23,17},{6,24,17},{6,25,18},{6,26,18},{6,27,18},{7,1,19},{7,2,19},{7,3,19},{7,4,20},{7,5,20},{7,6,20},{7,7,21},{7,8,21},{7,9,21},{7,10,22},{7,11,22},{7,12,22},{7,13,23},{7,14,23},{7,15,23},{7,16,24},{7,17,24},{7,18,24},{7,19,25},{7,20,25},{7,21,25},{7,22,26},{7,23,26},{7,24,26},{7,25,27},{7,26,27},{7,27,27},{8,1,19},{8,2,19},{8,3,19},{8,4,20},{8,5,20},{8,6,20},{8,7,21},{8,8,21},{8,9,21},{8,10,22},{8,11,22},{8,12,22},{8,13,23},{8,14,23},{8,15,23},{8,16,24},{8,17,24},{8,18,24},{8,19,25},{8,20,25},{8,21,25},{8,22,26},{8,23,26},{8,24,26},{8,25,27},{8,26,27},{8,27,27},{9,1,19},{9,2,19},{9,3,19},{9,4,20},{9,5,20},{9,6,20},{9,7,21},{9,8,21},{9,9,21},{9,10,22},{9,11,22},{9,12,22},{9,13,23},{9,14,23},{9,15,23},{9,16,24},{9,17,24},{9,18,24},{9,19,25},{9,20,25},{9,21,25},{9,22,26},{9,23,26},{9,24,26},{9,25,27},{9,26,27},{9,27,27}};
#endif

#ifdef CRATE6
block_coords detmap[NDETCHAN] = { {1,1,1},{1,2,1},{1,3,1},{1,4,2},{1,5,2},{1,6,2},{1,7,3},{1,8,3},{1,9,3},{1,10,4},{1,11,4},{1,12,4},{1,13,5},{1,14,5},{1,15,5},{1,16,6},{1,17,6},{1,18,6},{1,19,7},{1,20,7},{1,21,7},{1,22,8},{1,23,8},{1,24,8},{1,25,9},{1,26,9},{1,27,9},{2,1,1},{2,2,1},{2,3,1},{2,4,2},{2,5,2},{2,6,2},{2,7,3},{2,8,3},{2,9,3},{2,10,4},{2,11,4},{2,12,4},{2,13,5},{2,14,5},{2,15,5},{2,16,6},{2,17,6},{2,18,6},{2,19,7},{2,20,7},{2,21,7},{2,22,8},{2,23,8},{2,24,8},{2,25,9},{2,26,9},{2,27,9},{3,1,1},{3,2,1},{3,3,1},{3,4,2},{3,5,2},{3,6,2},{3,7,3},{3,8,3},{3,9,3},{3,10,4},{3,11,4},{3,12,4},{3,13,5},{3,14,5},{3,15,5},{3,16,6},{3,17,6},{3,18,6},{3,19,7},{3,20,7},{3,21,7},{3,22,8},{3,23,8},{3,24,8},{3,25,9},{3,26,9},{3,27,9},{4,1,10},{4,2,10},{4,3,10},{4,4,11},{4,5,11},{4,6,11},{4,7,12},{4,8,12},{4,9,12},{4,10,13},{4,11,13},{4,12,13},{4,13,14},{4,14,14},{4,15,14},{4,16,15},{4,17,15},{4,18,15},{4,19,16},{4,20,16},{4,21,16},{4,22,17},{4,23,17},{4,24,17},{4,25,18},{4,26,18},{4,27,18},{5,1,10},{5,2,10},{5,3,10},{5,4,11},{5,5,11},{5,6,11},{5,7,12},{5,8,12},{5,9,12},{5,10,13},{5,11,13},{5,12,13},{5,13,14},{5,14,14},{5,15,14},{5,16,15},{5,17,15},{5,18,15},{5,19,16},{5,20,16},{5,21,16},{5,22,17},{5,23,17},{5,24,17},{5,25,18},{5,26,18},{5,27,18},{6,1,10},{6,2,10},{6,3,10},{6,4,11},{6,5,11},{6,6,11},{6,7,12},{6,8,12},{6,9,12},{6,10,13},{6,11,13},{6,12,13},{6,13,14},{6,14,14},{6,15,14},{6,16,15},{6,17,15},{6,18,15},{6,19,16},{6,20,16},{6,21,16},{6,22,17},{6,23,17},{6,24,17},{6,25,18},{6,26,18},{6,27,18},{7,1,19},{7,2,19},{7,3,19},{7,4,20},{7,5,20},{7,6,20},{7,7,21},{7,8,21},{7,9,21},{7,10,22},{7,11,22},{7,12,22},{7,13,23},{7,14,23},{7,15,23},{7,16,24},{7,17,24},{7,18,24},{7,19,25},{7,20,25},{7,21,25},{7,22,26},{7,23,26},{7,24,26},{8,1,19},{8,2,19},{8,3,19},{8,4,20},{8,5,20},{8,6,20},{8,7,21},{8,8,21},{8,9,21},{8,10,22},{8,11,22},{8,12,22},{8,13,23},{8,14,23},{8,15,23},{8,16,24},{8,17,24},{8,18,24},{8,19,25},{8,20,25},{8,21,25},{8,22,26},{8,23,26},{8,24,26},{9,1,19},{9,2,19},{9,3,19},{9,4,20},{9,5,20},{9,6,20},{9,7,21},{9,8,21},{9,9,21},{9,10,22},{9,11,22},{9,12,22},{9,13,23},{9,14,23},{9,15,23},{9,16,24},{9,17,24},{9,18,24},{9,19,25},{9,20,25},{9,21,25},{9,22,26},{9,23,26},{9,24,26}};
#endif

#ifdef CRATE7
block_coords detmap[NDETCHAN] = { {1,1,1},{1,2,1},{1,3,1},{1,4,2},{1,5,2},{1,6,2},{1,7,3},{1,8,3},{1,9,3},{1,10,4},{1,11,4},{1,12,4},{1,13,5},{1,14,5},{1,15,5},{1,16,6},{1,17,6},{1,18,6},{1,19,7},{1,20,7},{1,21,7},{1,22,8},{1,23,8},{1,24,8},{2,1,1},{2,2,1},{2,3,1},{2,4,2},{2,5,2},{2,6,2},{2,7,3},{2,8,3},{2,9,3},{2,10,4},{2,11,4},{2,12,4},{2,13,5},{2,14,5},{2,15,5},{2,16,6},{2,17,6},{2,18,6},{2,19,7},{2,20,7},{2,21,7},{2,22,8},{2,23,8},{2,24,8},{3,1,1},{3,2,1},{3,3,1},{3,4,2},{3,5,2},{3,6,2},{3,7,3},{3,8,3},{3,9,3},{3,10,4},{3,11,4},{3,12,4},{3,13,5},{3,14,5},{3,15,5},{3,16,6},{3,17,6},{3,18,6},{3,19,7},{3,20,7},{3,21,7},{3,22,8},{3,23,8},{3,24,8},{4,1,9},{4,2,9},{4,3,9},{4,4,10},{4,5,10},{4,6,10},{4,7,11},{4,8,11},{4,9,11},{4,10,12},{4,11,12},{4,12,12},{4,13,13},{4,14,13},{4,15,13},{4,16,14},{4,17,14},{4,18,14},{4,19,15},{4,20,15},{4,21,15},{5,1,9},{5,2,9},{5,3,9},{5,4,10},{5,5,10},{5,6,10},{5,7,11},{5,8,11},{5,9,11},{5,10,12},{5,11,12},{5,12,12},{5,13,13},{5,14,13},{5,15,13},{5,16,14},{5,17,14},{5,18,14},{5,19,15},{5,20,15},{5,21,15},{6,1,9},{6,2,9},{6,3,9},{6,4,10},{6,5,10},{6,6,10},{6,7,11},{6,8,11},{6,9,11},{6,10,12},{6,11,12},{6,12,12},{6,13,13},{6,14,13},{6,15,13},{6,16,14},{6,17,14},{6,18,14},{6,19,15},{6,20,15},{6,21,15},{7,1,16},{7,2,16},{7,3,16},{7,4,17},{7,5,17},{7,6,17},{7,7,18},{7,8,18},{7,9,18},{7,10,19},{7,11,19},{7,12,19},{7,13,20},{7,14,20},{7,15,20},{7,16,21},{7,17,21},{7,18,21},{7,19,22},{7,20,22},{7,21,22},{8,1,16},{8,2,16},{8,3,16},{8,4,17},{8,5,17},{8,6,17},{8,7,18},{8,8,18},{8,9,18},{8,10,19},{8,11,19},{8,12,19},{8,13,20},{8,14,20},{8,15,20},{8,16,21},{8,17,21},{8,18,21},{8,19,22},{8,20,22},{8,21,22},{9,1,16},{9,2,16},{9,3,16},{9,4,17},{9,5,17},{9,6,17},{9,7,18},{9,8,18},{9,9,18},{9,10,19},{9,11,19},{9,12,19},{9,13,20},{9,14,20},{9,15,20},{9,16,21},{9,17,21},{9,18,21},{9,19,22},{9,20,22},{9,21,22},{10,1,23},{10,2,23},{10,3,23},{10,4,24},{10,5,24},{10,6,24},{10,7,25},{10,8,25},{10,9,25},{10,10,26},{10,11,26},{10,12,26},{10,13,27},{10,14,27},{10,15,27},{10,16,28},{10,17,28},{10,18,28},{11,1,23},{11,2,23},{11,3,23},{11,4,24},{11,5,24},{11,6,24},{11,7,25},{11,8,25},{11,9,25},{11,10,26},{11,11,26},{11,12,26},{11,13,27},{11,14,27},{11,15,27},{11,16,28},{11,17,28},{11,18,28},{12,1,23},{12,2,23},{12,3,23},{12,4,24},{12,5,24},{12,6,24},{12,7,25},{12,8,25},{12,9,25},{12,10,26},{12,11,26},{12,12,26},{12,13,27},{12,14,27},{12,15,27},{12,16,28},{12,17,28},{12,18,28}};
#endif

// ecal_cosmic_hls:
void ecal_cosmic_hls(
    TYPE_T hit_width,
    TYPE_ROWTHRESHOLD row_threshold,       // how many rows is required to be in coincidence
    hls::stream<fadc_hits_vxs> &s_fadc_hits_vxs,
    hls::stream<trigger_t> &s_trigger_t

)
{

#pragma HLS INTERFACE ap_fifo port=s_fadc_hits_vxs
#pragma HLS INTERFACE ap_fifo port=s_trigger_t

#pragma HLS PIPELINE II=1 style=flp

  fadc_hits_vxs fadc_hits = s_fadc_hits_vxs.read();
  static TYPE_LONGT fadc_hits_stream[NFADCCHAN]={0};

// for a single channel,if there is a hit, register the hit in fadc_hits_stream[ch][t]=1,
// and extend the hit time from the leading edge t to t+hit_width
// the follwoing hits within [t,t+hit_width] are ignored 
// This is similar to a discriminator module with adjustable output pulse width defined by hit_width
  int ch=0;
  int dt=0;
  for(ch=0; ch<NFADCCHAN; ch++){
     TYPE_T tt = fadc_hits.vxs_ch[ch].t;
     ap_uint<1> first = !fadc_hits_stream[ch][tt];   // check if there is already a hit at t
     for(dt=0; dt<8; dt++){
         if(fadc_hits.vxs_ch[ch].e>0 && dt<=hit_width && first){
            fadc_hits_stream[ch][tt+dt]=1;
         }
     }
  }

// Take OR of all columns of a row
  TYPE_TRIG row_or_hits[NROW] = {0};
  for(dt=0; dt<8; dt++){
     for(ch=0; ch<NFADCCHAN; ch++){
      TYPE_ROW tmp_row = detmap[ch].row;
      row_or_hits[tmp_row-1][dt] |= fadc_hits_stream[ch][dt];

#ifndef __SYNTHESIS__
      if(fadc_hits_stream[ch][dt])
         printf("hits at tt = %d, row = %d, col = %d, fadc chan=%d\n",dt,tmp_row.to_uint(),detmap[ch].col.to_uint(),ch);
#endif
     }
  }

#ifndef __SYNTHESIS__
  for(int ii=0; ii<NROW; ii++){
     int bit0 = row_or_hits[ii][0];
     int bit1 = row_or_hits[ii][1];
     int bit2 = row_or_hits[ii][2];
     int bit3 = row_or_hits[ii][3];
     int bit4 = row_or_hits[ii][4];
     int bit5 = row_or_hits[ii][5];
     int bit6 = row_or_hits[ii][6];
     int bit7 = row_or_hits[ii][7];
     if(row_or_hits[ii]) printf("row = %d hits time = %d%d%d%d%d%d%d%d\n",ii+1, bit0, bit1, bit2, bit3, bit4, bit5, bit6, bit7);
  }
#endif


// Pass the results of all the rows through a multiplicity threshold
  TYPE_TRIG multi_row_trig;  
  multi_row_trig = Trig_multiplicity(row_or_hits, row_threshold);
  
// Pass the multiplicity OR through a discriminator and the rising edge is the trigger time
  static ap_uint<1> lastT=0;  // the last time bit in the previous time frame
  TYPE_TRIG trig_t=0;

  trig_t = Disc(multi_row_trig, lastT); 

  trigger_t final_trig;
  final_trig.trig = trig_t;
  s_trigger_t.write(final_trig);

  lastT = multi_row_trig[7];

  for(ch=0; ch<NFADCCHAN; ch++)
      fadc_hits_stream[ch] = fadc_hits_stream[ch]>>8;

  return;
}

TYPE_TRIG Trig_multiplicity(TYPE_TRIG row_hits[NROW], TYPE_ROWTHRESHOLD row_threshold){

  int nrow=0;
  int tt=0;
  TYPE_ROW tot_hits[8]={0}; // number of planes fired per 4 ns

#ifndef __SYNTHESIS__
  for(int ii=0; ii<NROW; ii++){
     int bit0 = row_hits[ii][0];
     int bit1 = row_hits[ii][1];
     int bit2 = row_hits[ii][2];
     int bit3 = row_hits[ii][3];
     int bit4 = row_hits[ii][4];
     int bit5 = row_hits[ii][5];
     int bit6 = row_hits[ii][6];
     int bit7 = row_hits[ii][7];
     if(row_hits[ii]) printf("TRIG_MULTI: row = %d hits time = %d%d%d%d%d%d%d%d\n",ii+1, bit0, bit1, bit2, bit3, bit4, bit5, bit6, bit7);
  }
#endif


  TYPE_TRIG trig_t=0;
  for(tt=0; tt<8; tt++){
     for(nrow=0; nrow<NROW; nrow++){
        tot_hits[tt] += row_hits[nrow][tt]; 
     }  
     trig_t[tt] = (tot_hits[tt]>=row_threshold)?1:0;
  }

  return trig_t;
}


TYPE_TRIG Disc( TYPE_TRIG t_stream, ap_uint<1> lastT){
  
  int dt=0;
  TYPE_TRIG pre_t;
  TYPE_TRIG cur_t;

  pre_t[0] = lastT;
  for(dt=1; dt<8; dt++)
     pre_t[dt] = t_stream[dt-1];

  for(dt=0; dt<8; dt++)
     cur_t[dt] = t_stream[dt];

#ifndef __SYNTHESIS__
  int bit0 = pre_t[0];
  int bit1 = pre_t[1];
  int bit2 = pre_t[2];
  int bit3 = pre_t[3];
  int bit4 = pre_t[4];
  int bit5 = pre_t[5];
  int bit6 = pre_t[6];
  int bit7 = pre_t[7];
  printf("Disc: pre_t = %d%d%d%d%d%d%d%d\n",bit0, bit1, bit2, bit3, bit4, bit5, bit6, bit7);

  bit0 = cur_t[0];
  bit1 = cur_t[1];
  bit2 = cur_t[2];
  bit3 = cur_t[3];
  bit4 = cur_t[4];
  bit5 = cur_t[5];
  bit6 = cur_t[6];
  bit7 = cur_t[7];
  printf("Disc: cur_t = %d%d%d%d%d%d%d%d\n",bit0, bit1, bit2, bit3, bit4, bit5, bit6, bit7);
#endif
 

// if there is a rising edge, the trigger is geneated at the leading edge. 
  TYPE_TRIG trig_t=0;
  for(dt=0; dt<8; dt++)
     if(pre_t[dt]==0 && cur_t[dt]==1) trig_t[dt]=1;   

  return trig_t;
}
